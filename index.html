<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kiambogo Primary and Junior School â€” Fees Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@700&family=Source+Sans+3:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --primary:#1B3A6B;--primary-dark:#122952;--primary-light:#2a5298;
    --accent:#C8972B;
    --green:#166534;--green-bg:#dcfce7;
    --red:#991b1b;--red-bg:#fee2e2;
    --yellow:#92400e;--yellow-bg:#fef3c7;
    --bg:#EEF2F7;--white:#fff;--border:#d1dae6;
    --text:#1e293b;--muted:#64748b;
  }
  *{margin:0;padding:0;box-sizing:border-box;}
  body{font-family:'Source Sans 3',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;display:flex;flex-direction:column;}

  /* â”€â”€ AUTH SCREENS â”€â”€ */
  .auth-screen{position:fixed;inset:0;background:var(--primary-dark);display:flex;align-items:center;justify-content:center;z-index:1000;flex-direction:column;}
  .auth-screen.hidden{display:none;}
  .auth-box{background:#fff;border-radius:16px;width:400px;max-width:94vw;overflow:hidden;box-shadow:0 30px 80px rgba(0,0,0,.4);}
  .auth-top{background:var(--primary);padding:2rem 1.75rem 1.5rem;text-align:center;border-bottom:3px solid var(--accent);}
  .auth-crest{width:56px;height:56px;background:var(--accent);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.6rem;margin:0 auto .75rem;border:3px solid rgba(255,255,255,.25);}
  .auth-top h2{font-family:'Merriweather',serif;color:#fff;font-size:.95rem;line-height:1.4;}
  .auth-top p{color:rgba(255,255,255,.6);font-size:.7rem;text-transform:uppercase;letter-spacing:1.5px;margin-top:.3rem;}
  .auth-body{padding:1.75rem;}
  .auth-tabs{display:flex;border-bottom:2px solid var(--border);margin-bottom:1.25rem;}
  .auth-tab{flex:1;padding:.6rem;text-align:center;font-size:.82rem;font-weight:700;color:var(--muted);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-2px;transition:all .18s;}
  .auth-tab.active{color:var(--primary);border-bottom-color:var(--primary);}
  .auth-panel{display:none;}.auth-panel.active{display:block;}
  .fg{display:flex;flex-direction:column;gap:.3rem;margin-bottom:.85rem;}
  .fg label{font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--muted);}
  .fg input{padding:.6rem .9rem;border:1.5px solid var(--border);border-radius:8px;font-family:'Source Sans 3',sans-serif;font-size:.9rem;color:var(--text);background:var(--bg);outline:none;transition:border-color .2s;width:100%;}
  .fg input:focus{border-color:var(--primary);background:#fff;}
  .auth-err{font-size:.78rem;color:var(--red);min-height:1rem;margin-bottom:.5rem;}
  .auth-ok{font-size:.78rem;color:var(--green);min-height:1rem;margin-bottom:.5rem;}
  .auth-btn{width:100%;padding:.65rem;background:var(--primary);color:#fff;border:none;border-radius:8px;font-family:'Source Sans 3',sans-serif;font-weight:700;font-size:.9rem;cursor:pointer;transition:background .2s;}
  .auth-btn:hover{background:var(--primary-light);}
  .auth-btn:disabled{background:var(--muted);cursor:not-allowed;}
  .auth-link{text-align:center;font-size:.75rem;color:var(--muted);margin-top:.85rem;}
  .auth-link a{color:var(--primary);cursor:pointer;font-weight:600;}
  .auth-note{text-align:center;font-size:.7rem;color:var(--muted);margin-top:.75rem;line-height:1.5;}

  /* â”€â”€ LOADING â”€â”€ */
  .loading-overlay{position:fixed;inset:0;background:rgba(18,41,82,.55);display:flex;align-items:center;justify-content:center;z-index:900;backdrop-filter:blur(2px);}
  .loading-overlay.hidden{display:none;}
  .loading-box{background:#fff;border-radius:12px;padding:2rem 2.5rem;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,.3);}
  .spinner{width:36px;height:36px;border:3px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin .8s linear infinite;margin:0 auto .85rem;}
  @keyframes spin{to{transform:rotate(360deg);}}
  .loading-box p{font-size:.875rem;color:var(--muted);}

  /* â”€â”€ TOP BAR â”€â”€ */
  .topbar{background:var(--primary-dark);height:54px;display:flex;align-items:center;justify-content:space-between;padding:0 1.5rem;border-bottom:3px solid var(--accent);position:sticky;top:0;z-index:300;box-shadow:0 2px 12px rgba(0,0,0,.25);}
  .brand{display:flex;align-items:center;gap:.8rem;}
  .crest{width:36px;height:36px;background:var(--accent);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1rem;border:2px solid rgba(255,255,255,.25);}
  .brand h1{font-family:'Merriweather',serif;color:#fff;font-size:.82rem;}
  .brand p{color:rgba(255,255,255,.5);font-size:.65rem;text-transform:uppercase;letter-spacing:1.5px;}
  .topbar-right{display:flex;gap:.65rem;align-items:center;}
  .yr-badge{color:rgba(255,255,255,.9);font-size:.78rem;border:1px solid rgba(255,255,255,.25);padding:.25rem .75rem;border-radius:4px;background:rgba(255,255,255,.08);font-weight:600;}
  .sync-dot{width:8px;height:8px;border-radius:50%;background:#22c55e;display:inline-block;}
  .sync-dot.err{background:var(--red);}
  .sync-lbl{font-size:.72rem;color:rgba(255,255,255,.6);}

  /* â”€â”€ PROFILE DROPDOWN â”€â”€ */
  .profile-wrap{position:relative;}
  .profile-btn{display:flex;align-items:center;gap:.5rem;background:rgba(255,255,255,.1);border:1.5px solid rgba(255,255,255,.2);border-radius:8px;padding:.3rem .75rem;cursor:pointer;color:#fff;font-size:.78rem;font-family:'Source Sans 3',sans-serif;font-weight:600;transition:all .18s;}
  .profile-btn:hover{background:rgba(255,255,255,.18);}
  .profile-avatar{width:26px;height:26px;border-radius:50%;background:var(--accent);display:flex;align-items:center;justify-content:center;font-size:.75rem;font-weight:700;color:var(--primary-dark);}
  .profile-dropdown{position:absolute;top:calc(100% + .5rem);right:0;background:#fff;border-radius:10px;border:1px solid var(--border);box-shadow:0 8px 30px rgba(0,0,0,.15);width:240px;overflow:hidden;display:none;z-index:400;}
  .profile-dropdown.open{display:block;animation:rise .18s ease;}
  @keyframes rise{from{transform:translateY(8px);opacity:0;}to{transform:translateY(0);opacity:1;}}
  .pd-header{background:var(--primary);padding:.85rem 1rem;}
  .pd-name{color:#fff;font-weight:700;font-size:.875rem;}
  .pd-email{color:rgba(255,255,255,.6);font-size:.72rem;margin-top:.15rem;}
  .pd-item{display:flex;align-items:center;gap:.65rem;padding:.7rem 1rem;font-size:.82rem;color:var(--text);cursor:pointer;transition:background .15s;border-bottom:1px solid #f1f5f9;}
  .pd-item:last-child{border-bottom:none;}
  .pd-item:hover{background:#f8fafc;}
  .pd-item.danger{color:var(--red);}
  .pd-item.danger:hover{background:var(--red-bg);}

  /* â”€â”€ TABS â”€â”€ */
  .tabs-nav{background:var(--primary);display:flex;align-items:stretch;overflow-x:auto;scrollbar-width:none;border-bottom:2px solid rgba(255,255,255,.08);position:sticky;top:54px;z-index:200;}
  .tabs-nav::-webkit-scrollbar{display:none;}
  .tab-btn{padding:0 1rem;height:44px;border:none;background:transparent;color:rgba(255,255,255,.6);cursor:pointer;white-space:nowrap;font-family:'Source Sans 3',sans-serif;font-size:.8rem;font-weight:600;letter-spacing:.3px;border-bottom:3px solid transparent;transition:all .18s;flex-shrink:0;}
  .tab-btn:hover{color:#fff;background:rgba(255,255,255,.07);}
  .tab-btn.active{color:var(--accent);border-bottom-color:var(--accent);background:rgba(200,151,43,.1);}
  .tab-btn.archive-tab{color:rgba(255,200,100,.7);}
  .tab-btn.archive-tab.active{color:#fbbf24;border-bottom-color:#fbbf24;}

  /* â”€â”€ LAYOUT â”€â”€ */
  .main{flex:1;padding:1.5rem;max-width:1280px;width:100%;margin:0 auto;}
  .page{display:none;}.page.active{display:block;}

  /* â”€â”€ PROFILE PAGE â”€â”€ */
  .profile-page-grid{display:grid;grid-template-columns:1fr 1fr;gap:1.25rem;}
  .profile-card{background:#fff;border-radius:10px;border:1px solid var(--border);overflow:hidden;box-shadow:0 1px 4px rgba(0,0,0,.05);}
  .profile-card-head{background:var(--primary);padding:.85rem 1.25rem;}
  .profile-card-head h3{font-family:'Merriweather',serif;color:#fff;font-size:.9rem;}
  .profile-card-body{padding:1.25rem;}
  .profile-info-row{display:flex;justify-content:space-between;align-items:center;padding:.6rem 0;border-bottom:1px solid #f1f5f9;font-size:.875rem;}
  .profile-info-row:last-child{border-bottom:none;}
  .profile-info-label{color:var(--muted);font-size:.75rem;font-weight:600;text-transform:uppercase;letter-spacing:.5px;}
  .profile-info-value{color:var(--text);font-weight:600;}
  .profile-avatar-big{width:64px;height:64px;border-radius:50%;background:var(--accent);display:flex;align-items:center;justify-content:center;font-size:1.75rem;font-weight:700;color:var(--primary-dark);margin:0 auto 1rem;}

  /* â”€â”€ OVERVIEW STATS â”€â”€ */
  .ov-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;margin-bottom:1.5rem;}
  .ov-stat{background:#fff;border-radius:10px;padding:1rem 1.25rem;border:1px solid var(--border);border-left:4px solid var(--primary);box-shadow:0 1px 4px rgba(0,0,0,.05);}
  .ov-stat.g{border-left-color:var(--green);}.ov-stat.r{border-left-color:var(--red);}.ov-stat.a{border-left-color:var(--accent);}
  .ov-label{font-size:.68rem;text-transform:uppercase;letter-spacing:1px;color:var(--muted);font-weight:700;margin-bottom:.35rem;}
  .ov-num{font-family:'Merriweather',serif;font-size:1.7rem;color:var(--primary);line-height:1;}
  .ov-stat.g .ov-num{color:var(--green);}.ov-stat.r .ov-num{color:var(--red);}.ov-stat.a .ov-num{color:#7c5c1a;font-size:1.2rem;}
  .ov-sub{font-size:.72rem;color:var(--muted);margin-top:.25rem;}

  /* â”€â”€ CARDS â”€â”€ */
  .card{background:#fff;border-radius:10px;border:1px solid var(--border);overflow:hidden;box-shadow:0 1px 4px rgba(0,0,0,.05);}
  .card-head{background:var(--primary);padding:.85rem 1.25rem;display:flex;align-items:center;justify-content:space-between;}
  .card-head h2{font-family:'Merriweather',serif;color:#fff;font-size:.95rem;}
  .card-head .tag{font-size:.73rem;color:rgba(255,255,255,.65);background:rgba(255,255,255,.1);padding:.18rem .6rem;border-radius:20px;}

  /* â”€â”€ TABLE â”€â”€ */
  table{width:100%;border-collapse:collapse;}
  th{background:#f1f5fb;padding:.7rem 1rem;text-align:left;font-size:.68rem;text-transform:uppercase;letter-spacing:1px;color:var(--muted);font-weight:700;border-bottom:2px solid var(--border);}
  td{padding:.75rem 1rem;border-bottom:1px solid #edf2f7;font-size:.875rem;vertical-align:middle;}
  tr:last-child td{border-bottom:none;}tr:hover td{background:#f8fafc;}
  .tbl-scroll{overflow-x:auto;}

  /* â”€â”€ CLASS HEADER â”€â”€ */
  .cls-hdr{background:#fff;border-radius:10px;border:1px solid var(--border);padding:1rem 1.35rem;margin-bottom:1rem;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:.75rem;box-shadow:0 1px 4px rgba(0,0,0,.05);}
  .cls-title{font-family:'Merriweather',serif;font-size:1.1rem;color:var(--primary);}
  .mini-stats{display:flex;gap:1.25rem;}
  .ms{text-align:center;}
  .ms-num{font-family:'Merriweather',serif;font-size:1.2rem;color:var(--primary);}
  .ms-num.g{color:var(--green);}.ms-num.r{color:var(--red);}
  .ms-lbl{font-size:.65rem;text-transform:uppercase;letter-spacing:.8px;color:var(--muted);}

  /* â”€â”€ TOOLBAR â”€â”€ */
  .toolbar{background:#fff;border:1px solid var(--border);border-radius:10px;padding:.85rem 1.1rem;display:flex;gap:.65rem;align-items:center;flex-wrap:wrap;margin-bottom:1rem;box-shadow:0 1px 4px rgba(0,0,0,.04);}
  .sb{flex:1;min-width:180px;position:relative;}
  .sb input{width:100%;padding:.5rem .9rem .5rem 2.2rem;border:1.5px solid var(--border);border-radius:7px;font-family:'Source Sans 3',sans-serif;font-size:.875rem;color:var(--text);background:var(--bg);outline:none;transition:border-color .2s;}
  .sb input:focus{border-color:var(--primary);background:#fff;}
  .si{position:absolute;left:.7rem;top:50%;transform:translateY(-50%);color:var(--muted);font-size:.85rem;pointer-events:none;}
  select{padding:.5rem .85rem;border:1.5px solid var(--border);border-radius:7px;font-family:'Source Sans 3',sans-serif;font-size:.85rem;color:var(--text);background:var(--bg);outline:none;cursor:pointer;}
  select:focus{border-color:var(--primary);}

  /* â”€â”€ BUTTONS â”€â”€ */
  .btn{padding:.5rem 1.05rem;border-radius:7px;border:none;cursor:pointer;font-family:'Source Sans 3',sans-serif;font-weight:600;font-size:.85rem;display:inline-flex;align-items:center;gap:.35rem;transition:all .18s;white-space:nowrap;}
  .btn-primary{background:var(--primary);color:#fff;}.btn-primary:hover{background:var(--primary-light);}
  .btn-accent{background:var(--accent);color:#fff;}.btn-accent:hover{background:#b5821f;}
  .btn-ghost{background:transparent;color:var(--muted);border:1.5px solid var(--border);}.btn-ghost:hover{border-color:var(--primary);color:var(--primary);}
  .btn-gw{background:transparent;color:rgba(255,255,255,.7);border:1.5px solid rgba(255,255,255,.22);}.btn-gw:hover{border-color:var(--accent);color:var(--accent);}
  .btn-promote{background:#7c3aed;color:#fff;}.btn-promote:hover{background:#6d28d9;}
  .btn-danger{background:var(--red-bg);color:var(--red);border:1.5px solid #fecaca;}.btn-danger:hover{background:#fecaca;}
  .btn-sm{padding:.28rem .65rem;font-size:.75rem;border-radius:5px;}
  .btn-gs{background:var(--green-bg);color:var(--green);}.btn-gs:hover{background:#bbf7d0;}
  .btn-rs{background:var(--red-bg);color:var(--red);}.btn-rs:hover{background:#fecaca;}
  .btn-es{background:#dbeafe;color:#1e40af;}.btn-es:hover{background:#bfdbfe;}
  .btn-ds{background:#f1f5f9;color:var(--muted);}.btn-ds:hover{background:var(--red-bg);color:var(--red);}

  /* â”€â”€ BADGES â”€â”€ */
  .badge{display:inline-flex;align-items:center;gap:.25rem;padding:.22rem .65rem;border-radius:4px;font-size:.7rem;font-weight:700;text-transform:uppercase;letter-spacing:.3px;}
  .bp{background:var(--green-bg);color:var(--green);}.bpa{background:var(--yellow-bg);color:var(--yellow);}.bu{background:var(--red-bg);color:var(--red);}

  /* â”€â”€ PROGRESS â”€â”€ */
  .pb-wrap{display:flex;align-items:center;gap:.45rem;}
  .pb{width:65px;height:6px;background:#e2e8f0;border-radius:10px;overflow:hidden;flex-shrink:0;}
  .pf{height:100%;border-radius:10px;transition:width .4s;}
  .pct-lbl{font-size:.7rem;color:var(--muted);}

  .sname{font-weight:700;color:var(--primary-dark);}
  .paid-a{color:var(--green);font-weight:600;}
  .owed-a{color:var(--red);font-weight:600;}
  .acts{display:flex;gap:.35rem;align-items:center;}

  .empty{text-align:center;padding:3rem 2rem;color:var(--muted);display:none;}
  .empty-icon{font-size:2.2rem;margin-bottom:.65rem;}
  .empty p{font-size:.875rem;}

  /* â”€â”€ MODAL â”€â”€ */
  .overlay{position:fixed;inset:0;background:rgba(18,41,82,.65);display:none;align-items:center;justify-content:center;z-index:500;backdrop-filter:blur(3px);}
  .overlay.open{display:flex;}
  .modal{background:#fff;border-radius:14px;width:500px;max-width:96vw;overflow:hidden;box-shadow:0 25px 60px rgba(0,0,0,.3);animation:rise .22s ease;}
  .modal-head{background:var(--primary);padding:1rem 1.4rem;display:flex;align-items:center;justify-content:space-between;}
  .modal-head h3{font-family:'Merriweather',serif;color:#fff;font-size:1rem;}
  .mc{background:rgba(255,255,255,.15);border:none;color:#fff;width:26px;height:26px;border-radius:50%;cursor:pointer;font-size:.95rem;display:flex;align-items:center;justify-content:center;}
  .mc:hover{background:rgba(255,255,255,.25);}
  .modal-body{padding:1.4rem;}
  .form-row{display:grid;grid-template-columns:1fr 1fr;gap:.9rem;margin-bottom:.9rem;}
  .form-row.full{grid-template-columns:1fr;}
  .modal-foot{padding:.9rem 1.4rem;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:.65rem;background:#f8fafc;}

  /* â”€â”€ PROMOTE MODAL â”€â”€ */
  .promote-box{background:#fff;border-radius:14px;width:480px;max-width:96vw;overflow:hidden;box-shadow:0 25px 60px rgba(0,0,0,.4);animation:rise .25s ease;}
  .promote-head{background:#7c3aed;padding:1.1rem 1.4rem;display:flex;align-items:center;gap:.75rem;}
  .promote-head h3{font-family:'Merriweather',serif;color:#fff;font-size:1rem;}
  .promote-body{padding:1.5rem;}
  .promote-body p{font-size:.9rem;color:var(--text);line-height:1.6;margin-bottom:1rem;}
  .promote-list{background:#f8f5ff;border-radius:8px;padding:.9rem 1rem;font-size:.8rem;color:var(--muted);line-height:2;border:1px solid #e9d5ff;}
  .promote-warn{background:var(--yellow-bg);border:1px solid #fcd34d;border-radius:8px;padding:.75rem 1rem;font-size:.8rem;color:var(--yellow);margin-top:.9rem;}
  .promote-foot{padding:.9rem 1.4rem;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:.65rem;background:#faf9ff;}

  /* â”€â”€ ARCHIVE â”€â”€ */
  .archive-banner{background:linear-gradient(135deg,#78350f,#92400e);border-radius:10px;padding:1rem 1.35rem;margin-bottom:1rem;color:#fef3c7;display:flex;align-items:center;gap:.85rem;}
  .archive-banner .icon{font-size:1.5rem;}
  .archive-banner h3{font-family:'Merriweather',serif;font-size:.95rem;}
  .archive-banner p{font-size:.78rem;opacity:.8;margin-top:.15rem;}
  .cls-row{cursor:pointer;}.cls-row:hover td{background:#f0f4fb;}
  .cls-link{color:var(--primary);font-weight:700;}

  /* â”€â”€ PRINT â”€â”€ */
  .print-header{display:none;}
  @media print{
    .auth-screen,.topbar-right,.tabs-nav,.toolbar,.acts,.overlay,.btn,.btn-sm{display:none!important;}
    body{background:#fff;}
    .topbar{position:relative;top:auto;height:auto;padding:.75rem 1.5rem;print-color-adjust:exact;-webkit-print-color-adjust:exact;}
    .main{padding:.5rem;max-width:100%;}
    .page{display:block!important;}
    .card{box-shadow:none;border:1px solid #ccc;margin-bottom:1rem;page-break-inside:avoid;}
    th,td{font-size:.7rem;padding:.4rem .6rem;}
    .print-header{display:block!important;text-align:center;padding:.5rem 0 1rem;border-bottom:2px solid #C8972B;margin-bottom:1rem;}
    .print-header h2{font-family:'Merriweather',serif;font-size:1.1rem;color:#122952;}
    .print-header p{font-size:.75rem;color:#64748b;margin-top:.2rem;}
  }
  @media(max-width:768px){
    .ov-grid{grid-template-columns:1fr 1fr;}
    .main{padding:1rem;}
    .form-row{grid-template-columns:1fr;}
    .mini-stats{gap:.75rem;}
    .profile-page-grid{grid-template-columns:1fr;}
  }
</style>
</head>
<body>

<!-- â•â• LOADING â•â• -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-box">
    <div class="spinner"></div>
    <p id="loadingMsg">Loadingâ€¦</p>
  </div>
</div>

<!-- â•â• AUTH SCREEN â•â• -->
<div class="auth-screen" id="authScreen">
  <div class="auth-box">
    <div class="auth-top">
      <div class="auth-crest">ğŸ«</div>
      <h2>Kiambogo Primary and Junior School</h2>
      <p>Fees Management System</p>
    </div>
    <div class="auth-body">
      <div class="auth-tabs">
        <div class="auth-tab active" onclick="showAuthTab('login')">Sign In</div>
        <div class="auth-tab" onclick="showAuthTab('signup')">Sign Up</div>
        <div class="auth-tab" onclick="showAuthTab('reset')">Reset Password</div>
      </div>

      <!-- LOGIN -->
      <div class="auth-panel active" id="panel-login">
        <div class="fg"><label>Email Address</label><input type="email" id="login-email" placeholder="your@email.com" onkeydown="if(event.key==='Enter')doLogin()"></div>
        <div class="fg"><label>Password</label><input type="password" id="login-pw" placeholder="Your password" onkeydown="if(event.key==='Enter')doLogin()"></div>
        <div class="auth-err" id="login-err"></div>
        <button class="auth-btn" id="login-btn" onclick="doLogin()">ğŸ”“ Sign In</button>
        <div class="auth-note">Only authorised accounts can access this system.</div>
      </div>

      <!-- SIGNUP -->
      <div class="auth-panel" id="panel-signup">
        <div class="fg"><label>Full Name</label><input type="text" id="signup-name" placeholder="e.g. Collins Mwiti"></div>
        <div class="fg"><label>Email Address</label><input type="email" id="signup-email" placeholder="your@email.com"></div>
        <div class="fg"><label>Password</label><input type="password" id="signup-pw" placeholder="Min 8 characters"></div>
        <div class="fg"><label>Confirm Password</label><input type="password" id="signup-pw2" placeholder="Repeat password"></div>
        <div class="fg"><label>Admin Access Code</label><input type="password" id="signup-code" placeholder="Enter access code"></div>
        <div class="auth-err" id="signup-err"></div>
        <div class="auth-ok" id="signup-ok"></div>
        <button class="auth-btn" id="signup-btn" onclick="doSignup()">âœ‰ï¸ Create Account</button>
        <div class="auth-note">An access code is required to create an account. Contact the system administrator if you don't have one.</div>
      </div>

      <!-- RESET -->
      <div class="auth-panel" id="panel-reset">
        <div class="fg"><label>Email Address</label><input type="email" id="reset-email" placeholder="your@email.com"></div>
        <div class="auth-err" id="reset-err"></div>
        <div class="auth-ok" id="reset-ok"></div>
        <button class="auth-btn" id="reset-btn" onclick="doReset()">ğŸ“§ Send Reset Link</button>
        <div class="auth-note">A password reset link will be sent to your email address.</div>
      </div>
    </div>
  </div>
</div>

<!-- â•â• PRINT HEADER â•â• -->
<div class="print-header">
  <h2>Kiambogo Primary and Junior School</h2>
  <p>School Fees Report â€” Academic Year <span id="print-yr"></span></p>
  <p id="print-date"></p>
</div>

<!-- â•â• TOP BAR â•â• -->
<div class="topbar">
  <div class="brand">
    <div class="crest">ğŸ«</div>
    <div>
      <h1>Kiambogo Primary and Junior School</h1>
      <p>School Fees Management System</p>
    </div>
  </div>
  <div class="topbar-right">
    <span class="sync-dot" id="syncDot"></span>
    <span class="sync-lbl" id="syncLbl">Live</span>
    <span class="yr-badge" id="yrBadge"></span>
    <button class="btn btn-gw" onclick="exportAll()">â¬‡ï¸ Export</button>
    <button class="btn btn-gw" onclick="printReport()">ğŸ–¨ï¸ Print</button>
    <button class="btn btn-gw" onclick="openAddModal()">+ Add Student</button>
    <!-- PROFILE -->
    <div class="profile-wrap">
      <button class="profile-btn" onclick="toggleProfile()">
        <div class="profile-avatar" id="profileAvatar">?</div>
        <span id="profileName">Account</span>
        â–¾
      </button>
      <div class="profile-dropdown" id="profileDropdown">
        <div class="pd-header">
          <div class="pd-name" id="pd-name">â€”</div>
          <div class="pd-email" id="pd-email">â€”</div>
        </div>
        <div class="pd-item" onclick="switchTab('profile')">ğŸ‘¤ My Profile</div>
        <div class="pd-item" onclick="switchTab('profile');setTimeout(()=>document.getElementById('change-pw-section').scrollIntoView({behavior:'smooth'}),200)">ğŸ”‘ Change Password</div>
        <div class="pd-item danger" onclick="doLogout()">ğŸšª Sign Out</div>
      </div>
    </div>
  </div>
</div>

<!-- â•â• TABS â•â• -->
<nav class="tabs-nav" id="tabsNav"></nav>

<div class="main">

  <!-- OVERVIEW -->
  <div class="page active" id="page-overview">
    <div class="ov-grid">
      <div class="ov-stat"><div class="ov-label">Total Students</div><div class="ov-num" id="ov-total">0</div><div class="ov-sub">Active classes</div></div>
      <div class="ov-stat g"><div class="ov-label">Fully Paid</div><div class="ov-num" id="ov-paid">0</div><div class="ov-sub" id="ov-paid-pct">â€”</div></div>
      <div class="ov-stat r"><div class="ov-label">Unpaid / Partial</div><div class="ov-num" id="ov-unpaid">0</div><div class="ov-sub" id="ov-unpaid-pct">â€”</div></div>
      <div class="ov-stat a"><div class="ov-label">Total Outstanding</div><div class="ov-num" id="ov-owed">KSh 0</div><div class="ov-sub">Balance owed</div></div>
    </div>
    <div style="display:flex;justify-content:flex-end;margin-bottom:1rem;">
      <button class="btn btn-promote" onclick="openPromoteModal()">ğŸ“ Promote All Students to Next Year</button>
    </div>
    <div class="card">
      <div class="card-head"><h2>ğŸ“Š All Classes Summary</h2><span class="tag">Click a class to view students</span></div>
      <div class="tbl-scroll">
        <table>
          <thead><tr><th>Class</th><th>Students</th><th>Fully Paid</th><th>Unpaid / Partial</th><th>Collected</th><th>Outstanding</th><th>Collection Rate</th></tr></thead>
          <tbody id="ov-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- CLASS PAGES -->
  <div id="cls-pages"></div>

  <!-- ARCHIVE PAGE -->
  <div class="page" id="page-archive">
    <div class="archive-banner">
      <div class="icon">ğŸ“¦</div>
      <div>
        <h3>Archived Students â€” Graduated Grade 9</h3>
        <p>These students completed Grade 9 and have been moved out of active classes. Records are kept permanently.</p>
      </div>
    </div>
    <div class="toolbar">
      <div class="sb"><span class="si">ğŸ”</span><input type="text" id="arch-search" placeholder="Search archived studentsâ€¦" oninput="renderArchive()"></div>
      <button class="btn btn-ghost" onclick="exportArchive()">â¬‡ï¸ Export CSV</button>
    </div>
    <div class="card">
      <div class="card-head"><h2>ğŸ“¦ Archived Students</h2><span class="tag" id="arch-count">0 records</span></div>
      <div class="tbl-scroll">
        <table>
          <thead><tr><th>#</th><th>Name</th><th>Adm. No.</th><th>Parent Phone</th><th>Year Graduated</th><th>Total Fees</th><th>Amount Paid</th><th>Balance</th><th>Status</th></tr></thead>
          <tbody id="arch-tbody"></tbody>
        </table>
        <div class="empty" id="arch-empty"><div class="empty-icon">ğŸ“¦</div><p>No archived students yet.</p></div>
      </div>
    </div>
  </div>

  <!-- PROFILE PAGE -->
  <div class="page" id="page-profile">
    <div class="profile-page-grid">

      <!-- Account Info -->
      <div class="profile-card">
        <div class="profile-card-head"><h3>ğŸ‘¤ Account Information</h3></div>
        <div class="profile-card-body">
          <div class="profile-avatar-big" id="profile-avatar-big">?</div>
          <div class="profile-info-row"><span class="profile-info-label">Full Name</span><span class="profile-info-value" id="pi-name">â€”</span></div>
          <div class="profile-info-row"><span class="profile-info-label">Email</span><span class="profile-info-value" id="pi-email">â€”</span></div>
          <div class="profile-info-row"><span class="profile-info-label">Role</span><span class="profile-info-value">Administrator</span></div>
          <div class="profile-info-row"><span class="profile-info-label">School</span><span class="profile-info-value">Kiambogo Primary & Junior</span></div>
          <div style="margin-top:1rem;">
            <button class="btn btn-danger" onclick="doLogout()" style="width:100%">ğŸšª Sign Out</button>
          </div>
        </div>
      </div>

      <!-- Change Password -->
      <div class="profile-card" id="change-pw-section">
        <div class="profile-card-head"><h3>ğŸ”‘ Change Password</h3></div>
        <div class="profile-card-body">
          <div class="fg"><label>New Password</label><input type="password" id="new-pw" placeholder="Min 8 characters"></div>
          <div class="fg"><label>Confirm New Password</label><input type="password" id="new-pw2" placeholder="Repeat new password"></div>
          <div class="auth-err" id="pw-change-err"></div>
          <div class="auth-ok" id="pw-change-ok"></div>
          <button class="btn btn-primary" onclick="changePassword()" style="width:100%">ğŸ”‘ Update Password</button>
          <div style="margin-top:1.25rem;padding-top:1.25rem;border-top:1px solid var(--border);">
            <p style="font-size:.78rem;color:var(--muted);margin-bottom:.75rem;">Or send a password reset link to your email:</p>
            <button class="btn btn-ghost" onclick="sendResetFromProfile()" style="width:100%">ğŸ“§ Email Reset Link</button>
            <div class="auth-ok" id="profile-reset-ok" style="margin-top:.5rem;"></div>
          </div>
        </div>
      </div>

      <!-- System Info -->
      <div class="profile-card">
        <div class="profile-card-head"><h3>ğŸ“Š System Summary</h3></div>
        <div class="profile-card-body">
          <div class="profile-info-row"><span class="profile-info-label">Academic Year</span><span class="profile-info-value" id="pi-year">â€”</span></div>
          <div class="profile-info-row"><span class="profile-info-label">Total Students</span><span class="profile-info-value" id="pi-students">â€”</span></div>
          <div class="profile-info-row"><span class="profile-info-label">Total Archived</span><span class="profile-info-value" id="pi-archived">â€”</span></div>
          <div class="profile-info-row"><span class="profile-info-label">Database</span><span class="profile-info-value" style="color:var(--green)">â— Connected</span></div>
        </div>
      </div>

      <!-- Danger Zone -->
      <div class="profile-card">
        <div class="profile-card-head" style="background:var(--red);"><h3>âš ï¸ Danger Zone</h3></div>
        <div class="profile-card-body">
          <p style="font-size:.82rem;color:var(--muted);margin-bottom:1rem;line-height:1.6;">These actions are irreversible. Please be absolutely sure before proceeding.</p>
          <button class="btn btn-danger" onclick="openPromoteModal()" style="width:100%;margin-bottom:.75rem;">ğŸ“ Promote All Students (Year End)</button>
          <button class="btn btn-danger" onclick="confirmClearArchive()" style="width:100%">ğŸ—‘ï¸ Clear All Archived Records</button>
        </div>
      </div>

    </div>
  </div>

</div>

<!-- â•â• ADD/EDIT STUDENT MODAL â•â• -->
<div class="overlay" id="overlay" onclick="bgClose(event)">
  <div class="modal">
    <div class="modal-head"><h3 id="modal-title">Add New Student</h3><button class="mc" onclick="closeModal()">âœ•</button></div>
    <div class="modal-body">
      <div class="form-row full"><div class="fg"><label>Student Full Name *</label><input type="text" id="f-name" placeholder="e.g. Jane Wanjiku Kamau"></div></div>
      <div class="form-row">
        <div class="fg"><label>Class / Grade *</label><select id="f-class"></select></div>
        <div class="fg"><label>Admission No.</label><input type="text" id="f-adm" placeholder="e.g. 2024/031"></div>
      </div>
      <div class="form-row">
        <div class="fg"><label>Total Fees Required (KSh) *</label><input type="number" id="f-total" placeholder="e.g. 45000" min="0"></div>
        <div class="fg"><label>Amount Already Paid (KSh)</label><input type="number" id="f-paid" placeholder="0" min="0" value="0"></div>
      </div>
      <div class="form-row full"><div class="fg"><label>Parent / Guardian Phone</label><input type="tel" id="f-phone" placeholder="e.g. 0712 345 678"></div></div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveStudent()">ğŸ’¾ Save Record</button>
    </div>
  </div>
</div>

<!-- â•â• PROMOTE MODAL â•â• -->
<div class="overlay" id="promoteOverlay" onclick="if(event.target===this)closePromoteModal()">
  <div class="promote-box">
    <div class="promote-head"><span style="font-size:1.4rem">ğŸ“</span><h3>Year-End Student Promotion</h3></div>
    <div class="promote-body">
      <p>This will promote <strong>all active students</strong> to the next class for the new academic year:</p>
      <div class="promote-list" id="promote-preview"></div>
      <div class="promote-warn">âš ï¸ <strong>Grade 9 students</strong> will be archived. Fees reset to KSh 0 for the new year. This cannot be undone.</div>
    </div>
    <div class="promote-foot">
      <button class="btn btn-ghost" onclick="closePromoteModal()">Cancel</button>
      <button class="btn btn-promote" onclick="confirmPromote()">âœ… Yes, Promote All Students</button>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// âš™ï¸ CONFIGURATION â€” hardcoded for reliability
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SUPABASE_URL = 'https://dgnzmzwmdlshvvnbzkvx.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRnbnptendtZGxzaHZ2bmJ6a3Z4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0OTI4MzgsImV4cCI6MjA4NzA2ODgzOH0.PwEyYwR7dfoppGPk0qQ8B361ayOFKoi9XK5IVn-b7ds';

// âš ï¸ CHANGE THIS before uploading â€” your secret developer master password
// This lets you log into any system you build using this code
const MASTER_PASSWORD = 'Collins24!';

// Access code required to sign up (share only with authorised people)
const SIGNUP_ACCESS_CODE = 'KiambogoAccess2025';

const CLASSES = ['Pre-Primary 1','Pre-Primary 2','Grade 1','Grade 2','Grade 3','Grade 4','Grade 5','Grade 6','Grade 7','Grade 8','Grade 9'];
const YEAR_KEY = 'kpjs_year_v3';

let students  = [];
let archived  = [];
let activeTab = 'overview';
let editId    = null;
let currentUser = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SUPABASE API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function sbFetch(path, opts={}) {
  const headers = {
    'apikey': SUPABASE_KEY,
    'Authorization': 'Bearer ' + (currentUser?.access_token || SUPABASE_KEY),
    'Content-Type': 'application/json',
    ...(opts.headers||{})
  };
  const res = await fetch(SUPABASE_URL + path, {...opts, headers});
  const text = await res.text();
  if (!res.ok) { console.error('SB error', res.status, text); return null; }
  return text ? JSON.parse(text) : [];
}

async function sbAuth(path, body) {
  const res = await fetch(SUPABASE_URL + '/auth/v1' + path, {
    method:'POST',
    headers:{'apikey':SUPABASE_KEY,'Content-Type':'application/json'},
    body: JSON.stringify(body)
  });
  const data = await res.json();
  if (!res.ok) throw new Error(data.error_description || data.msg || 'Auth error');
  return data;
}

async function sbGetAll(table) {
  return await sbFetch('/rest/v1/' + table + '?select=*&order=name.asc') || [];
}

async function sbUpsert(table, row) {
  return await sbFetch('/rest/v1/' + table, {
    method:'POST',
    headers:{'Prefer':'resolution=merge-duplicates,return=representation'},
    body: JSON.stringify(row)
  });
}

async function sbDelete(table, id) {
  return await sbFetch('/rest/v1/' + table + '?id=eq.' + encodeURIComponent(id), {method:'DELETE'});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showAuthTab(tab) {
  document.querySelectorAll('.auth-tab').forEach((t,i)=>{
    const tabs=['login','signup','reset'];
    t.classList.toggle('active', tabs[i]===tab);
  });
  document.querySelectorAll('.auth-panel').forEach(p=>p.classList.remove('active'));
  document.getElementById('panel-'+tab).classList.add('active');
}

async function doLogin() {
  const email = document.getElementById('login-email').value.trim();
  const pw    = document.getElementById('login-pw').value;
  const errEl = document.getElementById('login-err');
  const btn   = document.getElementById('login-btn');
  errEl.textContent='';

  // Developer master password check
  if (pw === MASTER_PASSWORD) {
    currentUser = { email:'developer@master', access_token: SUPABASE_KEY, user_metadata:{full_name:'Developer'} };
    onLoginSuccess();
    return;
  }

  if (!email || !pw) { errEl.textContent='Please enter email and password.'; return; }
  btn.disabled=true; btn.textContent='Signing inâ€¦';
  try {
    const data = await sbAuth('/token?grant_type=password', {email, password:pw});
    currentUser = {...data.user, access_token: data.access_token};
    onLoginSuccess();
  } catch(e) {
    errEl.textContent = 'âœ• ' + (e.message==='Invalid login credentials' ? 'Incorrect email or password.' : e.message);
  }
  btn.disabled=false; btn.textContent='ğŸ”“ Sign In';
}

async function doSignup() {
  const name  = document.getElementById('signup-name').value.trim();
  const email = document.getElementById('signup-email').value.trim();
  const pw    = document.getElementById('signup-pw').value;
  const pw2   = document.getElementById('signup-pw2').value;
  const code  = document.getElementById('signup-code').value.trim();
  const errEl = document.getElementById('signup-err');
  const okEl  = document.getElementById('signup-ok');
  const btn   = document.getElementById('signup-btn');
  errEl.textContent=''; okEl.textContent='';

  if (!name)              { errEl.textContent='Please enter your full name.'; return; }
  if (!email)             { errEl.textContent='Please enter your email.'; return; }
  if (pw.length < 8)      { errEl.textContent='Password must be at least 8 characters.'; return; }
  if (pw !== pw2)         { errEl.textContent='Passwords do not match.'; return; }
  if (code !== SIGNUP_ACCESS_CODE) { errEl.textContent='âœ• Invalid access code. Contact the administrator.'; return; }

  btn.disabled=true; btn.textContent='Creating accountâ€¦';
  try {
    await sbAuth('/signup', {email, password:pw, data:{full_name:name}});
    okEl.textContent='âœ… Account created! Check your email to verify, then sign in.';
    document.getElementById('signup-name').value='';
    document.getElementById('signup-email').value='';
    document.getElementById('signup-pw').value='';
    document.getElementById('signup-pw2').value='';
    document.getElementById('signup-code').value='';
  } catch(e) {
    errEl.textContent='âœ• ' + e.message;
  }
  btn.disabled=false; btn.textContent='âœ‰ï¸ Create Account';
}

async function doReset() {
  const email = document.getElementById('reset-email').value.trim();
  const errEl = document.getElementById('reset-err');
  const okEl  = document.getElementById('reset-ok');
  const btn   = document.getElementById('reset-btn');
  errEl.textContent=''; okEl.textContent='';
  if (!email) { errEl.textContent='Please enter your email address.'; return; }
  btn.disabled=true; btn.textContent='Sendingâ€¦';
  try {
    await fetch(SUPABASE_URL+'/auth/v1/recover',{
      method:'POST',
      headers:{'apikey':SUPABASE_KEY,'Content-Type':'application/json'},
      body:JSON.stringify({email})
    });
    okEl.textContent='âœ… Reset link sent! Check your email inbox.';
  } catch(e) { errEl.textContent='âœ• Could not send reset email.'; }
  btn.disabled=false; btn.textContent='ğŸ“§ Send Reset Link';
}

async function sendResetFromProfile() {
  const okEl = document.getElementById('profile-reset-ok');
  okEl.textContent='Sendingâ€¦';
  try {
    await fetch(SUPABASE_URL+'/auth/v1/recover',{
      method:'POST',
      headers:{'apikey':SUPABASE_KEY,'Content-Type':'application/json'},
      body:JSON.stringify({email: currentUser.email})
    });
    okEl.textContent='âœ… Reset link sent to ' + currentUser.email;
  } catch(e) { okEl.textContent='âœ• Could not send reset email.'; okEl.style.color='var(--red)'; }
}

async function changePassword() {
  const pw   = document.getElementById('new-pw').value;
  const pw2  = document.getElementById('new-pw2').value;
  const errEl= document.getElementById('pw-change-err');
  const okEl = document.getElementById('pw-change-ok');
  errEl.textContent=''; okEl.textContent='';
  if (pw.length < 8)  { errEl.textContent='Password must be at least 8 characters.'; return; }
  if (pw !== pw2)     { errEl.textContent='Passwords do not match.'; return; }
  try {
    const res = await fetch(SUPABASE_URL+'/auth/v1/user',{
      method:'PUT',
      headers:{'apikey':SUPABASE_KEY,'Authorization':'Bearer '+currentUser.access_token,'Content-Type':'application/json'},
      body:JSON.stringify({password:pw})
    });
    if (res.ok) {
      okEl.textContent='âœ… Password updated successfully!';
      document.getElementById('new-pw').value='';
      document.getElementById('new-pw2').value='';
    } else { errEl.textContent='âœ• Could not update password. Try the email reset option.'; }
  } catch(e) { errEl.textContent='âœ• Error updating password.'; }
}

function doLogout() {
  currentUser=null;
  students=[]; archived=[];
  document.getElementById('authScreen').classList.remove('hidden');
  document.getElementById('profileDropdown').classList.remove('open');
  document.getElementById('login-email').value='';
  document.getElementById('login-pw').value='';
}

function onLoginSuccess() {
  document.getElementById('authScreen').classList.add('hidden');
  // Set profile info
  const name = currentUser.user_metadata?.full_name || currentUser.email?.split('@')[0] || 'Admin';
  const email = currentUser.email || 'â€”';
  const initials = name.split(' ').map(n=>n[0]).join('').toUpperCase().slice(0,2);
  document.getElementById('profileAvatar').textContent = initials;
  document.getElementById('profileName').textContent = name.split(' ')[0];
  document.getElementById('pd-name').textContent = name;
  document.getElementById('pd-email').textContent = email;
  document.getElementById('profile-avatar-big').textContent = initials;
  document.getElementById('pi-name').textContent = name;
  document.getElementById('pi-email').textContent = email;

  showLoading('Loading student recordsâ€¦');
  loadData().then(()=>{ refreshAll(); hideLoading(); checkYearRollover(); });
}

function toggleProfile() {
  document.getElementById('profileDropdown').classList.toggle('open');
}

document.addEventListener('click', e=>{
  if (!document.getElementById('profileDropdown').contains(e.target) &&
      !document.querySelector('.profile-btn').contains(e.target)) {
    document.getElementById('profileDropdown').classList.remove('open');
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOADING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showLoading(msg='Loadingâ€¦') {
  document.getElementById('loadingMsg').textContent=msg;
  document.getElementById('loadingOverlay').classList.remove('hidden');
}
function hideLoading() { document.getElementById('loadingOverlay').classList.add('hidden'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadData() {
  const [s,a] = await Promise.all([sbGetAll('students'), sbGetAll('archived_students')]);
  students = (s||[]).map(r=>({id:r.id,name:r.name,cls:r.cls,adm:r.adm,total:Number(r.total),paid:Number(r.paid),phone:r.phone}));
  archived = (a||[]).map(r=>({id:r.id,name:r.name,cls:r.cls,adm:r.adm,total:Number(r.total),paid:Number(r.paid),phone:r.phone,graduatedYear:r.graduated_year}));
  document.getElementById('syncDot').className='sync-dot';
  document.getElementById('syncLbl').textContent='Live';
}

async function pushStudent(s) {
  document.getElementById('syncDot').className='sync-dot err';
  document.getElementById('syncLbl').textContent='Syncingâ€¦';
  await sbUpsert('students',{id:s.id,name:s.name,cls:s.cls,adm:s.adm||'',total:s.total,paid:s.paid,phone:s.phone||''});
  document.getElementById('syncDot').className='sync-dot';
  document.getElementById('syncLbl').textContent='Live';
}

async function pushArchive(s) {
  await sbUpsert('archived_students',{id:s.id,name:s.name,cls:s.cls,adm:s.adm||'',total:s.total,paid:s.paid,phone:s.phone||'',graduated_year:s.graduatedYear});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// YEAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const getCurrentYear = () => new Date().getFullYear();
const getStoredYear  = () => parseInt(localStorage.getItem(YEAR_KEY)||getCurrentYear());
const setStoredYear  = y  => localStorage.setItem(YEAR_KEY,y);

function updateYearBadge() {
  const y=getStoredYear();
  document.getElementById('yrBadge').textContent=y+'/'+(y+1);
  document.getElementById('print-yr').textContent=y+' / '+(y+1);
  document.getElementById('pi-year').textContent=y+' / '+(y+1);
}

function checkYearRollover() {
  if(getCurrentYear()>getStoredYear()&&students.length>0)
    setTimeout(()=>openPromoteModal(),700);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const fmt    = n => 'KSh '+Number(n||0).toLocaleString();
const pct    = (p,t) => t>0?Math.min(100,Math.round(p/t*100)):0;
const status = (p,t) => p>=t&&t>0?'paid':p>0?'partial':'unpaid';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BUILD UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildNav() {
  const nav=document.getElementById('tabsNav');
  let html=`<button class="tab-btn active" data-t="overview" onclick="switchTab('overview')">ğŸ“Š Overview</button>`;
  CLASSES.forEach((c,i)=>{ html+=`<button class="tab-btn" data-t="c${i}" onclick="switchTab('c${i}')">${c}</button>`; });
  html+=`<button class="tab-btn archive-tab" data-t="archive" onclick="switchTab('archive')">ğŸ“¦ Archive</button>`;
  html+=`<button class="tab-btn" data-t="profile" onclick="switchTab('profile')">ğŸ‘¤ Profile</button>`;
  nav.innerHTML=html;
}

function buildPages() {
  document.getElementById('cls-pages').innerHTML=CLASSES.map((cls,i)=>`
    <div class="page" id="page-c${i}">
      <div class="cls-hdr">
        <div class="cls-title">ğŸ« ${cls}</div>
        <div class="mini-stats">
          <div class="ms"><div class="ms-num" id="mn-t${i}">0</div><div class="ms-lbl">Students</div></div>
          <div class="ms"><div class="ms-num g" id="mn-p${i}">0</div><div class="ms-lbl">Paid</div></div>
          <div class="ms"><div class="ms-num r" id="mn-u${i}">0</div><div class="ms-lbl">Unpaid</div></div>
          <div class="ms"><div class="ms-num" style="color:#7c5c1a;font-size:.95rem" id="mn-o${i}">KSh 0</div><div class="ms-lbl">Outstanding</div></div>
        </div>
      </div>
      <div class="toolbar">
        <div class="sb"><span class="si">ğŸ”</span><input type="text" id="sq${i}" placeholder="Search studentsâ€¦" oninput="renderClass(${i})"></div>
        <select id="sf${i}" onchange="renderClass(${i})">
          <option value="">All Statuses</option>
          <option value="paid">Paid</option>
          <option value="partial">Partial</option>
          <option value="unpaid">Unpaid</option>
        </select>
        <button class="btn btn-ghost" onclick="exportClass(${i})">â¬‡ï¸ Export</button>
        <button class="btn btn-accent" onclick="openAddModal(${i})">+ Add Student</button>
      </div>
      <div class="card">
        <div class="card-head"><h2>${cls} â€” Students</h2><span class="tag" id="rc${i}">0 records</span></div>
        <div class="tbl-scroll">
          <table>
            <thead><tr><th>#</th><th>Name</th><th>Adm. No.</th><th>Parent Phone</th><th>Amount Paid</th><th>Balance Owed</th><th>Progress</th><th>Status</th><th>Actions</th></tr></thead>
            <tbody id="tb${i}"></tbody>
          </table>
          <div class="empty" id="em${i}"><div class="empty-icon">ğŸ“‚</div><p>No students yet in ${cls}.</p></div>
        </div>
      </div>
    </div>`).join('');
}

function buildClassDropdown() {
  document.getElementById('f-class').innerHTML=
    `<option value="">â€” Select Class â€”</option>`+
    CLASSES.map(c=>`<option value="${c}">${c}</option>`).join('');
}

function refreshAll() {
  updateYearBadge();
  document.getElementById('pi-students').textContent=students.length;
  document.getElementById('pi-archived').textContent=archived.length;
  renderOverview();
  CLASSES.forEach((_,i)=>renderClass(i));
  renderArchive();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAB SWITCHING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(t) {
  activeTab=t;
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.toggle('active',b.dataset.t===t));
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById('page-'+t).classList.add('active');
  document.getElementById('profileDropdown').classList.remove('open');
  if(t==='overview') renderOverview();
  else if(t==='archive') renderArchive();
  else if(t==='profile') {
    document.getElementById('pi-students').textContent=students.length;
    document.getElementById('pi-archived').textContent=archived.length;
  }
  else renderClass(parseInt(t.slice(1)));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER OVERVIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderOverview() {
  const n=students.length;
  const pc=students.filter(s=>status(s.paid,s.total)==='paid').length;
  const uc=n-pc;
  const owed=students.reduce((a,s)=>a+Math.max(0,s.total-s.paid),0);
  document.getElementById('ov-total').textContent=n;
  document.getElementById('ov-paid').textContent=pc;
  document.getElementById('ov-unpaid').textContent=uc;
  document.getElementById('ov-owed').textContent=fmt(owed);
  document.getElementById('ov-paid-pct').textContent=n?Math.round(pc/n*100)+'% of students':'â€”';
  document.getElementById('ov-unpaid-pct').textContent=n?Math.round(uc/n*100)+'% of students':'â€”';
  document.getElementById('ov-tbody').innerHTML=CLASSES.map((cls,i)=>{
    const s=students.filter(x=>x.cls===cls);
    const tot=s.length,pn=s.filter(x=>status(x.paid,x.total)==='paid').length,un=tot-pn;
    const col=s.reduce((a,x)=>a+x.paid,0),out=s.reduce((a,x)=>a+Math.max(0,x.total-x.paid),0);
    const rate=pct(col,s.reduce((a,x)=>a+x.total,0));
    const rc=rate===100?'var(--green)':rate>=60?'#b45309':rate>0?'var(--red)':'var(--muted)';
    return `<tr class="cls-row" onclick="switchTab('c${i}')">
      <td><span class="cls-link">${cls}</span></td>
      <td><strong>${tot}</strong></td>
      <td style="color:var(--green);font-weight:600">${pn}</td>
      <td style="color:${un>0?'var(--red)':'var(--muted)'};font-weight:${un>0?600:400}">${un}</td>
      <td>${fmt(col)}</td>
      <td>${out>0?`<span style="color:var(--red);font-weight:600">${fmt(out)}</span>`:`<span style="color:var(--muted)">â€”</span>`}</td>
      <td><div class="pb-wrap"><div class="pb"><div class="pf" style="width:${rate}%;background:${rc}"></div></div><span class="pct-lbl" style="color:${rc}">${rate}%</span></div></td>
    </tr>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER CLASS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderClass(i) {
  const cls=CLASSES[i];
  const q=(document.getElementById('sq'+i)?.value||'').toLowerCase();
  const fs=document.getElementById('sf'+i)?.value||'';
  let list=students.filter(s=>s.cls===cls);
  const n=list.length,pn=list.filter(s=>status(s.paid,s.total)==='paid').length;
  const ow=list.reduce((a,s)=>a+Math.max(0,s.total-s.paid),0);
  document.getElementById('mn-t'+i).textContent=n;
  document.getElementById('mn-p'+i).textContent=pn;
  document.getElementById('mn-u'+i).textContent=n-pn;
  document.getElementById('mn-o'+i).textContent=fmt(ow);
  if(q) list=list.filter(s=>s.name.toLowerCase().includes(q)||(s.adm||'').toLowerCase().includes(q)||(s.phone||'').includes(q));
  if(fs) list=list.filter(s=>status(s.paid,s.total)===fs);
  const tbody=document.getElementById('tb'+i);
  const empty=document.getElementById('em'+i);
  document.getElementById('rc'+i).textContent=list.length+' record'+(list.length!==1?'s':'');
  if(!list.length){tbody.innerHTML='';empty.style.display='block';return;}
  empty.style.display='none';
  tbody.innerHTML=list.map((s,idx)=>{
    const st=status(s.paid,s.total),p=pct(s.paid,s.total);
    const oa=Math.max(0,s.total-s.paid);
    const bc=st==='paid'?'bp':st==='partial'?'bpa':'bu';
    const bt=st==='paid'?'âœ“ Paid':st==='partial'?'âš  Partial':'âœ— Unpaid';
    const pc2=p===100?'#166534':p>=50?'#b45309':'#991b1b';
    const ip=st==='paid';
    return `<tr>
      <td style="color:var(--muted);font-size:.75rem;width:32px">${idx+1}</td>
      <td><div class="sname">${s.name}</div></td>
      <td style="color:var(--muted);font-size:.8rem">${s.adm||'â€”'}</td>
      <td style="font-size:.8rem">${s.phone||'â€”'}</td>
      <td class="paid-a">${fmt(s.paid)}</td>
      <td>${oa>0?`<span class="owed-a">${fmt(oa)}</span>`:`<span style="color:var(--muted)">â€”</span>`}</td>
      <td><div class="pb-wrap"><div class="pb"><div class="pf" style="width:${p}%;background:${pc2}"></div></div><span class="pct-lbl">${p}%</span></div></td>
      <td><span class="badge ${bc}">${bt}</span></td>
      <td><div class="acts">
        <button class="btn btn-sm ${ip?'btn-rs':'btn-gs'}" onclick="togglePaid('${s.id}',${i})">${ip?'â†© Unpay':'âœ“ Mark Paid'}</button>
        <button class="btn btn-sm btn-es" onclick="openEditModal('${s.id}')">Edit</button>
        <button class="btn btn-sm btn-ds" onclick="delStudent('${s.id}',${i})">âœ•</button>
      </div></td>
    </tr>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER ARCHIVE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderArchive() {
  const q=(document.getElementById('arch-search')?.value||'').toLowerCase();
  let list=archived;
  if(q) list=list.filter(s=>s.name.toLowerCase().includes(q)||(s.adm||'').toLowerCase().includes(q));
  const tbody=document.getElementById('arch-tbody');
  const empty=document.getElementById('arch-empty');
  document.getElementById('arch-count').textContent=list.length+' record'+(list.length!==1?'s':'');
  if(!list.length){tbody.innerHTML='';empty.style.display='block';return;}
  empty.style.display='none';
  tbody.innerHTML=list.map((s,i)=>{
    const st=status(s.paid,s.total);
    const bc=st==='paid'?'bp':st==='partial'?'bpa':'bu';
    const bt=st==='paid'?'âœ“ Paid':st==='partial'?'âš  Partial':'âœ— Unpaid';
    return `<tr>
      <td style="color:var(--muted);font-size:.75rem">${i+1}</td>
      <td><div class="sname">${s.name}</div></td>
      <td style="color:var(--muted);font-size:.8rem">${s.adm||'â€”'}</td>
      <td style="font-size:.8rem">${s.phone||'â€”'}</td>
      <td style="font-size:.8rem;color:#92400e;font-weight:600">${s.graduatedYear||'â€”'}</td>
      <td>${fmt(s.total)}</td>
      <td class="paid-a">${fmt(s.paid)}</td>
      <td>${Math.max(0,s.total-s.paid)>0?`<span class="owed-a">${fmt(Math.max(0,s.total-s.paid))}</span>`:`<span style="color:var(--muted)">â€”</span>`}</td>
      <td><span class="badge ${bc}">${bt}</span></td>
    </tr>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROMOTE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openPromoteModal() {
  document.getElementById('promote-preview').innerHTML=CLASSES.map((cls,i)=>{
    const n=students.filter(s=>s.cls===cls).length;
    return i===CLASSES.length-1
      ?`ğŸ“¦ ${cls} (${n} students) â†’ <strong>Archived</strong>`
      :`â¡ï¸ ${cls} (${n} students) â†’ ${CLASSES[i+1]}`;
  }).join('<br>');
  document.getElementById('promoteOverlay').classList.add('open');
}
function closePromoteModal(){document.getElementById('promoteOverlay').classList.remove('open');}

async function confirmPromote(){
  closePromoteModal();
  showLoading('Promoting studentsâ€¦ please wait');
  const nowYear=getCurrentYear();
  const grade9=students.filter(s=>s.cls===CLASSES[CLASSES.length-1]);
  for(const s of grade9){
    const ar={...s,graduatedYear:nowYear};
    archived.push(ar);
    await pushArchive(ar);
    await sbDelete('students',s.id);
  }
  const promoted=students
    .filter(s=>s.cls!==CLASSES[CLASSES.length-1])
    .map(s=>({...s,cls:CLASSES[CLASSES.indexOf(s.cls)+1],paid:0}));
  students=promoted;
  for(const s of promoted) await pushStudent(s);
  setStoredYear(nowYear);
  hideLoading();
  refreshAll();
  alert(`âœ… Done!\nAll students promoted.\n${grade9.length} Grade 9 student(s) archived.\nFees reset for ${nowYear}/${nowYear+1}.`);
}

function confirmClearArchive(){
  if(!confirm('Are you sure you want to permanently delete ALL archived records? This cannot be undone.')) return;
  if(!confirm('Last warning â€” this will delete all graduated student records forever. Continue?')) return;
  archived=[];
  renderArchive();
  alert('All archived records cleared.');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOGGLE PAID
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function togglePaid(id,i){
  const s=students.find(x=>x.id===id);
  if(!s) return;
  s.paid=status(s.paid,s.total)==='paid'?0:s.total;
  await pushStudent(s);
  renderClass(i);
  if(activeTab==='overview') renderOverview();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openAddModal(clsIdx=null){
  editId=null;
  document.getElementById('modal-title').textContent='Add New Student';
  ['f-name','f-adm','f-phone'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('f-total').value='';
  document.getElementById('f-paid').value='0';
  if(clsIdx!==null) document.getElementById('f-class').value=CLASSES[clsIdx];
  else if(activeTab.startsWith('c')) document.getElementById('f-class').value=CLASSES[parseInt(activeTab.slice(1))];
  else document.getElementById('f-class').value='';
  document.getElementById('overlay').classList.add('open');
  setTimeout(()=>document.getElementById('f-name').focus(),100);
}

function openEditModal(id){
  editId=id;
  const s=students.find(x=>x.id===id);
  document.getElementById('modal-title').textContent='Edit Student Record';
  document.getElementById('f-name').value=s.name;
  document.getElementById('f-class').value=s.cls;
  document.getElementById('f-adm').value=s.adm||'';
  document.getElementById('f-total').value=s.total;
  document.getElementById('f-paid').value=s.paid;
  document.getElementById('f-phone').value=s.phone||'';
  document.getElementById('overlay').classList.add('open');
  setTimeout(()=>document.getElementById('f-name').focus(),100);
}

function closeModal(){document.getElementById('overlay').classList.remove('open');editId=null;}
function bgClose(e){if(e.target===document.getElementById('overlay'))closeModal();}

async function saveStudent(){
  const name=document.getElementById('f-name').value.trim();
  const cls=document.getElementById('f-class').value;
  const adm=document.getElementById('f-adm').value.trim();
  const total=parseFloat(document.getElementById('f-total').value)||0;
  const paid=Math.min(parseFloat(document.getElementById('f-paid').value)||0,total);
  const phone=document.getElementById('f-phone').value.trim();
  if(!name){alert('Please enter the student name.');return;}
  if(!cls){alert('Please select a class.');return;}
  if(total<=0){alert('Please enter a valid total fees amount.');return;}
  const rec={id:editId||(Date.now().toString()+Math.random().toString(36).slice(2)),name,cls,adm,total,paid,phone};
  if(editId){const idx=students.findIndex(x=>x.id===editId);students[idx]=rec;}
  else students.push(rec);
  await pushStudent(rec);
  closeModal();
  renderOverview();
  const ci=CLASSES.indexOf(cls);
  if(ci>=0) renderClass(ci);
  if(!editId) switchTab('c'+ci);
}

async function delStudent(id,i){
  if(!confirm('Remove this student record? This cannot be undone.')) return;
  students=students.filter(s=>s.id!==id);
  await sbDelete('students',id);
  renderClass(i); renderOverview();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORT & PRINT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportClass(i){
  const cls=CLASSES[i];
  dlCSV([['No','Name','Class','Adm No','Parent Phone','Total Fees','Amount Paid','Balance','Status'],
    ...students.filter(s=>s.cls===cls).map((s,idx)=>[idx+1,s.name,s.cls,s.adm||'',s.phone||'',s.total,s.paid,Math.max(0,s.total-s.paid),status(s.paid,s.total).toUpperCase()])],
    'fees_'+cls.replace(/ /g,'_'));
}
function exportAll(){
  dlCSV([['No','Name','Class','Adm No','Parent Phone','Total Fees','Amount Paid','Balance','Status'],
    ...students.map((s,i)=>[i+1,s.name,s.cls,s.adm||'',s.phone||'',s.total,s.paid,Math.max(0,s.total-s.paid),status(s.paid,s.total).toUpperCase()])],
    'kiambogo_fees_all');
}
function exportArchive(){
  dlCSV([['No','Name','Adm No','Parent Phone','Year Graduated','Total Fees','Amount Paid','Balance','Status'],
    ...archived.map((s,i)=>[i+1,s.name,s.adm||'',s.phone||'',s.graduatedYear||'',s.total,s.paid,Math.max(0,s.total-s.paid),status(s.paid,s.total).toUpperCase()])],
    'kiambogo_archived');
}
function dlCSV(rows,name){
  const a=document.createElement('a');
  a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(rows.map(r=>r.map(v=>`"${v}"`).join(',')).join('\n'));
  a.download=name+'_'+new Date().toISOString().slice(0,10)+'.csv'; a.click();
}
function printReport(){
  document.getElementById('print-date').textContent='Printed: '+new Date().toLocaleDateString('en-KE',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
  window.print();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
buildNav();
buildPages();
buildClassDropdown();
updateYearBadge();
hideLoading();
</script>
</body>
</html>
